<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!--DO NOT FORGET THIS SCRIPT TAG SO YOU CAN USE JQUERY!!!!!-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!--YOUR OWN JAVASCRIPT CAN GO RIGHT HERE-->
    <script type="text/javascript">


        //we're using a stacked card approach for our main viewing area
        //this array holds the ids of our cards and
        //the method allows us to easly switch the interface from one to the other
        var contentPanels = ['logonPanel', 'mainPanel', 'responsePanel', 'commentPanel', 'archivedPanel'];

        //this function toggles which panel is showing
        function showPanel(panelId) {
            // clearData();
            for (var i = 0; i < contentPanels.length; i++) {
                if (panelId == contentPanels[i]) {
                    $("#" + contentPanels[i]).css("visibility", "visible");
                }
                else {
                    $("#" + contentPanels[i]).css("visibility", "hidden");
                }
            }
        }

        function LogOn(userId, pass) {
            //the url of the webservice we will be talking to
            //CASE SENSITIVE!!
            var webMethod = "ProjectServices.asmx/LogOn";
            //the parameters we will pass the service (in json format because curly braces)
            //note we encode the values for transmission over the web.  All the \'s are just
            //because we want to wrap our keynames and values in double quotes so we have to
            //escape the double quotes (because the overall string we're creating is in double quotes!)
            var parameters = "{\"uid\":\"" + encodeURI(userId) + "\",\"pass\":\"" + encodeURI(pass) + "\"}";

            //jQuery ajax method
            $.ajax({
                //post is more secure than get, and allows
                //us to send big data if we want.  really just
                //depends on the way the service you're talking to is set up, though
                type: "POST",
                //the url is set to the string we created above
                url: webMethod,
                //same with the data
                data: parameters,
                //these next two key/value pairs say we intend to talk in JSON format
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                //jQuery sends the data and asynchronously waits for a response.  when it
                //gets a response, it calls the function mapped to the success key here
                success: function (msg) {
                    //the server response is in the msg object passed in to the function here
                    //since our logon web method simply returns a true/false, that value is mapped
                    //to a generic property of the server response called d (I assume short for data
                    //but honestly I don't know...)
                    if (msg.d) {
                        //server replied true, so show the landing page: mainPanel
                        showPanel('mainPanel');
                        ShowMenu();
                        skipsRemaining = 3; // Reset skips to 3
                    }
                    else {
                        //server replied false, so let the user know
                        //the logon failed
                        alert("logon failed");
                    }
                },
                error: function (e) {
                    //if something goes wrong in the mechanics of delivering the
                    //message to the server or the server processing that message,
                    //then this function mapped to the error key is executed rather
                    //than the one mapped to the success key.
                    alert("Error in delivering the message to the server or the server processing that message");
                }
            });
        }

        // Function to submit a suggestion
        function submitSuggestion() {
            var suggestion = $("#suggestionText").val();
            if (suggestion.trim() === "") {
                alert("Please enter a suggestion.");
                return;
            }
            var webMethod = "ProjectServices.asmx/SubmitSuggestion";
            var parameters = JSON.stringify({ suggestion: suggestion });

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    var response = JSON.parse(msg.d);
                    if (response.success) {
                        alert("Suggestion submitted successfully!");
                        $("#suggestionText").val(""); // Clear input after success
                    } else {
                        alert("Submission failed: " + response.message);
                    }
                },
                error: function () {
                    alert("Error connecting to the server.");
                }
            });
        }


        //just shows the menu
        function ShowMenu() {
            $("#menu").css("visibility", "visible");
        }

        //just hides the menu
        function HideMenu() {
            $("#menu").css("visibility", "hidden");
        }

        //resets the logon inputs
        function clearLogon() {
            $('#logonId').val("");
            $('#logonPassword').val("");
        }

        //resets comments panel
        function clearCommentsPage() {
            document.getElementById("commentPanel").innerHTML = "";
        }

        // resets archived comments panel
        function clearArchivedPage() {
            document.getElementById("archivedPanel").innerHTML = "";
        }

        function clearResponsePanel() {
            document.getElementById("randomCommentDisplay").innerHTML = "";
            skipTrackerArray = [];
            activeCommentCount = 0;
            skipsRemaining = 3;
        }

        //this function clears data from all panels
        function clearData() {
            clearLogon();
            clearCommentsPage();
            clearArchivedPage();
            clearResponsePanel();
        }

        //logs the user off both at the client and at the server
        function LogOff() {

            var webMethod = "ProjectServices.asmx/LogOff";
            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d) {
                        //we logged off, so go back to logon page,
                        showPanel('logonPanel');
                        HideMenu();
                        clearData();
                    }
                    else {
                    }
                },
                error: function (e) {
                    alert("Error in delivering the message to the server or the server processing that message");
                }
            });
        }

        // Ensure the DOM is fully loaded before attaching event listeners
        $(document).ready(function () {
            // Event listener for "Load Random Comment" button
            $(".randomCommentButton").click(function () {
                loadRandomComment();
            });

            // Event listener for Skip button
            $("#skipButton").click(function () {
                handleSkip();
            });
        });



        // Store the current comment to display the same one if the user cancels the skip
        var currentComment = "";
        var savedComment = ""; // Variable to save the comment for later use

        // track skipped comments to avoid showing repeats
        var skipTrackerArray = [];
        var activeCommentCount;

        function getCommentCount() {

            var webMethod = "ProjectServices.asmx/CountComments";
            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    activeCommentCount = msg.d;
                },
                error: function (e) {
                    alert("Error in delivering the message to the server or the server processing that message");
                }
            });
        }

        // Function to load a random comment from the server
        function loadRandomComment() {

            getCommentCount();
            var webMethod = "ProjectServices.asmx/GetRandomComment";

            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({}), // No additional parameters needed
                success: function (response) {
                    // Check if response contains a valid comment

                    console.log("Active comments: " + activeCommentCount); // for testing
                    console.log(skipTrackerArray); // for testing
                    console.log("Skips remaining: " + skipsRemaining); // for testing
                    if (response.d && typeof response.d === "string" && response.d.trim() !== "") {
                        if (skipTrackerArray.length < activeCommentCount) {
                            if (!skipTrackerArray.includes(response.d)) {
                                skipTrackerArray.push(response.d);
                                currentComment = response.d; // Store the new comment
                                $("#randomCommentDisplay").text(currentComment); // Display comment
                                savedComment = currentComment; // Save the comment for later use
                                console.log("Saved Comment: " + savedComment); // Log the saved comment for debugging
                                // Show the response panel and ensure other panels are hidden
                                showPanel("responsePanel");
                            }
                            else {
                                // Load another comment if it's a repeat
                                loadRandomComment();
                            }
                        }
                        else {
                            $("#randomCommentDisplay").text("No comments found."); // Handle empty response
                        }
                    }
                    else {
                        $("#randomCommentDisplay").text("No comments found.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", xhr.responseText);
                    alert("Error loading comment.");
                }
            });
        }

        // Track the number of skips remaining
        var skipsRemaining = 3; // Example initial value

        // Function to handle the skip action
        function handleSkip() {
            if (skipsRemaining > 0) {
                let userConfirmed = confirm("Are you sure you want to skip this comment?");

                if (userConfirmed) {
                    skipsRemaining--;
                    loadRandomComment(); // Load a new comment only if the user confirms
                } else {
                    // If user cancels, show the same comment again
                    $("#randomCommentDisplay").text(savedComment);
                }
            } else {
                alert("You have no more skips!");
                // Ensure the displayed comment remains the same
                $("#randomCommentDisplay").text(savedComment);
            }
        }

        // Function to handle the cancel action
        $("#cancelButton").on("click", function () {
            $("#randomCommentDisplay").text(savedComment); // Display the saved comment
        });

        // array to hold comments and their respective replies and user info for each
        var commentsArray;

        function showActiveComments() {
            var webMethod = "ProjectServices.asmx/GetActiveComments";
            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d.length > 0) {
                        commentsArray = msg.d;
                        $("#commentPanel").empty();

                        // Count replies with the same commentID (i.e. all replies to a single comment)
                        for (var i = 0; i < commentsArray.length; i++) {
                            var count = 0;
                            for (var j = i + 1; j < commentsArray.length; j++) {
                                if (commentsArray[i].commentID == commentsArray[j].commentID) {
                                    count++;
                                }
                            }
                            // Create the base comment HTML structure
                            var comment =
                                "<div id='comment" + i + "'>" +
                                "<p>" + commentsArray[i].comment_firstname + " " +
                                commentsArray[i].comment_lastname + ": " +
                                commentsArray[i].comment_content + "</p>" +
                                "<p>" + commentsArray[i].reply_firstname + " " +
                                commentsArray[i].reply_lastname + ": " +
                                commentsArray[i].reply_content + "</p>" +

                                "</div><hr>";
                            // Append the comment to the #commentPanel
                            // !! VERY IMPORTANT !! Must append <div> to DOM before you can append to it
                            $("#commentPanel").append(comment);

                            // Append remaining replies associated with this comment
                            for (var c = i + 1; c <= count + i; c++) {
                                // Append each reply to the associated comment div
                                $("#comment" + i).append(
                                    "<p>" + commentsArray[c].reply_firstname + " " +
                                    commentsArray[c].reply_lastname + ": " +
                                    commentsArray[c].reply_content + "</p>");
                            }
                            $("#comment" + i).append(
                                // Delete and Archive button PLACEHOLDERS
                                "<button >Archive</button>" +
                                "<button >Delete</button>"
                            );
                            // Skip number of replies to avoid repeating them (i.e. we already added them above)
                            i = i + count;
                        }
                        showPanel('commentPanel');
                    }
                    else {
                        alert("No comments to show or you do not have access rights.")
                    }
                },
                error: function (e) {
                    alert("Error in delivering the message to the server or the server processing that message");
                }
            });
        }

        function showArchivedComments() {
            var webMethod = "ProjectServices.asmx/GetArchivedComments";
            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d.length > 0) {
                        commentsArray = msg.d;
                        $("#archivedPanel").empty();

                        // Count replies with the same commentID (i.e. all replies to a single comment)
                        for (var i = 0; i < commentsArray.length; i++) {
                            var count = 0;
                            for (var j = i + 1; j < commentsArray.length; j++) {
                                if (commentsArray[i].commentID == commentsArray[j].commentID) {
                                    count++;
                                }
                            }
                            // Create the comment HTML structure
                            var comment =
                                "<div id='archcomment" + i + "'>" +
                                "<p>" + commentsArray[i].comment_firstname + " " +
                                commentsArray[i].comment_lastname + ": " +
                                commentsArray[i].comment_content + "</p>" +
                                "<p>" + commentsArray[i].reply_firstname + " " +
                                commentsArray[i].reply_lastname + ": " +
                                commentsArray[i].reply_content + "</p>" +

                                "</div><hr>";
                            // Append the comment to the #archivedPanel
                            // !! VERY IMPORTANT !! Must append <div> to DOM before you can append to it
                            $("#archivedPanel").append(comment);

                            // Append remaining replies associated with this comment
                            for (var c = i + 1; c <= count + i; c++) {
                                // Append each reply to the associated comment div
                                $("#archcomment" + i).append(
                                    "<p>" + commentsArray[c].reply_firstname + " " +
                                    commentsArray[c].reply_lastname + ": " +
                                    commentsArray[c].reply_content + "</p>");
                            }
                            $("#archcomment" + i).append(
                                // Delete & Unarchive button PLACEHOLDERS
                                "<button >Unarchive</button>" +
                                "<button >Delete</button>"
                            );
                            // Skip number of replies to avoid repeating them (i.e. we already added them above)
                            i = i + count;
                        }
                        showPanel('archivedPanel');
                    }
                    else {
                        alert("No comments to show or you do not have access rights.")
                    }
                },
                error: function (e) {
                    alert("Error in delivering the message to the server or the server processing that message");
                }
            });
        }

        //this function executes once jQuery has successfully loaded and is
        //ready for business.  Usually, if we're wiring up event handlers via jQuery
        //then this is where they go.
        jQuery(function () {
            //when the app loads, show the logon panel to start with!
            showPanel('logonPanel');

        });

    </script>
    <!--END OF YOUR OWN JAVASCRIPT-->
    <!--AND YOUR OWN CSS CAN GO HERE AS WELL-->
    <style>
        /*Colors for this project area as follows:
            dark blue:#002d62
            light blue:#3ab0ff
            white:#f5f5f5
            light green:#00c49a*/

        * {
            margin: 0;
            padding: 0;
        }


        /* hidden by default */
        .menu {
            visibility: hidden;
            font-family: "Open Sans", serif;
            font-optical-sizing: auto;
            font-weight: 100;
            font-style: normal;
            background-color: black;
            width: 100%;
        }


        /* hidden by default */
        .contentPanel {
            visibility: hidden;
            position: absolute;
            background: linear-gradient(to right, #00c49a, #3ab0ff);
            width: 100%;
            height: 100%;
        }

        .title {
            font-family: "Montserrat", serif;
            font-size: xx-large;
            font-weight: 700;
            font-style: normal;
            color: #f5f5f5;
        }


        .titleContainer {
            background-color: black;
            width: 100%
        }

        .header {
            font-family: "Montserrat", serif;
            font-size: x-large;
            font-weight: 500;
            font-style: normal;
            color: black;
            background-color: #3ab0ff;
        }


        .body {
            font-family: "Open Sans", serif;
            font-size: large;
            font-weight: 500;
            font-style: normal;
        }

        .button {
            font-family: "Open Sans", serif;
            font-size: medium;
            font-weight: 500;
            font-style: normal;
            color: #f5f5f5;
            background-color: black;
            min-width: 150px;
        }

        .commentPanel {
            height: 100%
        }

        .archivedPanel {
            height: 100%
        }



    </style>
    <!--END OF YOUR OWN CSS-->
</head>
<body>

	<!-- Build Menu Here -->
	<div class="titleContainer">
		<span class="title">Feedback!</span>
        <div id="menu" class="menu">
            <button class="button" onclick=showActiveComments()>Show Active Comments</button>
            <button class="button" onclick=showArchivedComments()>Show Archived Comments</button>
            <button class="button" onclick=LogOff()>Log Off</button>
            <hr />
        </div>
	</div>

	<!--
		we're using a stacked card approach for our main viewing area
		add cards within contentContainer array (above in JavaScript section) as individual divs
		!! DON'T FORGET TO ADD DIV ID TO JAVASCRIPT ARRAY: contentPanels !!
		that method allows us to easly switch the interface from one to the other
	 -->
    <div class="contentContainer">

        <div id="logonPanel" class="contentPanel logonPanel">
            <div class="logonBox body">
                <form onsubmit="LogOn($('#logonId').val(), $('#logonPassword').val()); return false;">
                    <div class="left header">Log On</div>
                    <hr />
                    <div>
                        ID: <input type="text" id="logonId" class="body" />
                    </div>
                    <div>
                        Pwd: <input type="password" id="logonPassword" class="body" />
                    </div>
                    <hr />
                    <div>
                        <button class="button" type="submit">Go!</button>
                    </div>
                </form>
            </div>
        </div>


        <div id="mainPanel" class="contentPanel mainPanel">
            <div class="left header">This is a placeholder for the Banner!</div>
            <!-- Suggestion Input Box -->
            <textarea id="suggestionText" class="body" placeholder="Enter your suggestion here..."></textarea>

            <!-- Submit Button -->
            <button class="button" onclick="submitSuggestion()">Submit Suggestion</button>

            <!-- Button that the user clicks to load a random comment -->
            <button class="randomCommentButton button">Load Random Comment</button>
        </div>


        <div id="responsePanel" class="responsePanel contentPanel body">
            <!-- The div where the random comment will be displayed -->
            <div id="randomCommentDisplay"></div>

            <!-- Add button here to save comment and load next -->
            <!-- Skip Button -->
            <button id="skipButton" class="button">Skip</button>

        </div>

        <!-- Panel to display active comments and replies -->
        <div id="commentPanel" class="contentPanel commentPanel body"></div>

        <!-- Panel to display archived comments and replies -->
        <div id="archivedPanel" class="contentPanel archivedPanel body"></div>
    </div>

</body>
</html>
